<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UTILITY PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.5/dist/signature_pad.umd.min.js"></script>
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#3b82f6" />

    <!-- iOS meta tags -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Documentos Policiais" />
    <link rel="apple-touch-icon" href="icon.png" />

    <!-- Windows meta tags -->
    <meta name="msapplication-TileImage" content="icon.png" />
    <meta name="msapplication-TileColor" content="#3b82f6" />
    <style>
      @media print {
        .no-print {
          display: none !important;
        }

        /* Hide borders when printing */
        .signature-pad {
          border: none !important;
        }

        /* Ensure proper A4 layout for print */
        body {
          margin: 0;
          padding: 0;
        }

        .tab-content {
          max-width: none !important;
          width: 210mm !important;
          min-height: 297mm !important;
          margin: 0 !important;
          padding: 15mm !important;
          box-sizing: border-box;
        }
      }

      .input-field {
        border-bottom: 1px solid black;
        padding: 3px 0;
        margin-bottom: 2px;
        min-height: 24px;
      }

      .header-input {
        border-bottom: none;
        padding: 3px 0;
        margin-bottom: 0;
        font-weight: bold;
        font-size: 1.25rem;
        text-align: center;
        width: 100%;
      }

      .static-field {
        border-bottom: 1px solid #666;
        min-height: 30px;
        margin-bottom: 5px;
      }

      .text-area-field {
        border: 1px solid #666;
        width: 100%;
        min-height: 100px; /* Increased height for more writing space */
        margin-top: 5px;
        margin-bottom: 10px;
      }

      body {
        font-family: Arial, sans-serif;
      }

      img {
        max-width: 100%;
        height: auto;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .tab {
        cursor: pointer;
        padding: 10px 20px;
        border: 1px solid #ccc;
        background-color: #f1f1f1;
        border-radius: 5px 5px 0 0;
        margin-right: 2px;
      }

      .tab.active {
        background-color: white;
        border-bottom: 1px solid white;
      }

      .signature-container {
        margin: 10px 0;
        text-align: left;
        width: 100%;
      }

      .signature-pad {
        border: 1px solid #000;
        margin-bottom: 10px;
        background-color: #fff;
        width: 100%;
        max-width: 500px;
      }

      /* Add a class for export mode without borders */
      .export-mode .signature-pad {
        border: none;
      }

      .clear-button {
        background-color: #f44336;
        color: white;
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-bottom: 15px;
      }

      .signature-name-field {
        width: 100%;
        max-width: 500px;
        border-bottom: 1px solid #666;
        padding: 5px 0;
        margin-bottom: 10px;
        font-weight: bold;
      }

      /* Footer styles */
      .footer {
        background-color: #f8f9fa;
        padding: 15px 0;
        text-align: center;
        margin-top: 30px;
        border-top: 1px solid #e9ecef;
        font-size: 14px;
        color: #6c757d;
      }

      .footer a {
        color: #007bff;
        text-decoration: none;
      }

      .footer a:hover {
        text-decoration: underline;
      }

      /* PDF optimization styles */
      .pdf-container {
        width: 210mm;
        min-height: 297mm;
        margin: 0 auto;
        padding: 15mm;
        box-sizing: border-box;
        background: white;
        font-size: 12pt;
        line-height: 1.4;
      }
    </style>
  </head>
  <body class="bg-gray-100 p-4">
    <!-- Tabs navigation -->
    <div class="max-w-4xl mx-auto mb-2 no-print">
      <div class="flex border-b border-gray-200">
        <div class="tab active" onclick="openTab(event, 'relatorio-medico')">
          Relatório Médico
        </div>
        <div class="tab" onclick="openTab(event, 'termo-manifestacao')">
          Termo de Manifestação do Ofendido
        </div>
        <div class="tab" onclick="openTab(event, 'termo-compromisso')">
          Termo de Compromisso de Comparecimento
        </div>
      </div>
    </div>

    <!-- Tab 1: Relatório Médico -->
    <div
      id="relatorio-medico"
      class="tab-content active max-w-4xl mx-auto bg-white p-6 rounded shadow"
    >
      <!-- Header with logos -->
      <div class="flex justify-between items-center mb-4">
        <img
          src="https://upload.wikimedia.org/wikipedia/commons/1/12/PMGO_Logo.png"
          alt="PMGO Logo"
          class="h-24"
          id="pmgo-logo"
        />
        <img
          src="https://upload.wikimedia.org/wikipedia/commons/b/bf/Bras%C3%A3o_de_Goi%C3%A1s.svg"
          alt="Estado de Goiás Coat of Arms"
          class="h-24"
          id="goias-logo"
        />
      </div>

      <!-- Headers -->
      <h2 class="text-2xl font-bold text-center mb-4">ESTADO DE GOIÁS</h2>
      <h3 class="text-xl font-bold text-center mb-2">
        POLÍCIA MILITAR DE GOIÁS
      </h3>

      <!-- Campos editáveis para o cabeçalho do Relatório Médico -->
      <div class="mb-2">
        <input
          type="text"
          class="header-input"
          value="11º COMANDO REGIONAL DE POLÍCIA MILITAR"
          placeholder="(informar CRPM) COMANDO REGIONAL DE POLÍCIA MILITAR"
        />
      </div>
      <div class="mb-2">
        <input
          type="text"
          class="header-input"
          value="14ª COMPANHIA INDEPENDENTE DE POLÍCIA MILITAR"
          placeholder="(informar unidade) DE POLÍCIA MILITAR"
        />
      </div>
      <div class="mb-4">
        <input
          type="text"
          class="header-input"
          value="2º PEL OPERACIONAL PM"
          placeholder="(informar pelotão/operação)"
        />
      </div>

      <p class="text-center mb-4">
        RAI nº:
        <input
          type="text"
          class="input-field w-32 inline-block"
          id="rai-relatorio"
        />
      </p>

      <h3 class="text-xl font-bold text-center mb-4">RELATÓRIO MÉDICO</h3>

      <p class="text-center mb-4">
        (Comunicação obrigatória de fato no exercício da Medicina, artigo 66 -
        II, do Decreto Lei n: 3.688 de 03/10/1941, LCP e artigo 112 do Código de
        Ética médica).
      </p>

      <!-- Editable fields -->
      <div class="mb-2">
        <strong>Paciente:</strong>
        <input
          type="text"
          id="paciente"
          class="input-field w-full max-w-md"
          placeholder="Nome do paciente"
        />
      </div>

      <div class="mb-2">
        <strong>Filiação:</strong>
        <input
          type="text"
          id="filiacao"
          class="input-field w-full max-w-md"
          placeholder="Filiação"
        />
      </div>

      <div class="mb-4">
        <strong>Endereço:</strong>
        <input
          type="text"
          id="endereco"
          class="input-field w-full max-w-md"
          placeholder="Endereço"
        />
      </div>

      <!-- Static fields for manual filling with larger text areas -->
      <div class="mb-4">
        <p class="mb-2"><strong>I - ESTADO GERAL:</strong></p>
        <div class="static-field text-area-field"></div>
      </div>

      <div class="mb-4">
        <p class="mb-2">
          <strong>II - LESÕES APRESENTADAS</strong> (Descrever as lesões quanto
          ao tipo, dimensões, planos e gravidade):
        </p>
        <div class="static-field text-area-field"></div>
      </div>

      <div class="mb-4">
        <p class="mb-2">
          <strong>III - Instrumento ou meio que produziu a ofensa:</strong>
        </p>
        <div class="static-field text-area-field"></div>
      </div>

      <div class="mb-4">
        <p class="mb-2"><strong>IV - Tratamento feito:</strong></p>
        <div class="static-field text-area-field"></div>
      </div>

      <div class="mb-4">
        <p class="mb-2">
          <strong>V - Seqüelas que futuramente poderá apresentar:</strong>
        </p>
        <div class="static-field text-area-field"></div>
      </div>

      <div class="mb-4">
        <p class="mb-2">
          <strong
            >VI - O paciente poderá ficar afastado de suas funções por
            ____________ dia(s).</strong
          >
        </p>
      </div>

      <div class="mb-2">
        <p>
          Local e data: ____________________ / GO, ____ de ____________ de
          _______
        </p>
      </div>

      <div class="mb-2">
        <p>Nosocômio: _________________________________________________</p>
      </div>

      <div class="mb-4">
        <p>Médico: _______________________________ CRM: _____________ / ___</p>
      </div>
    </div>

    <!-- Tab 2: Termo de Manifestação do Ofendido -->
    <div
      id="termo-manifestacao"
      class="tab-content max-w-4xl mx-auto bg-white p-6 rounded shadow"
    >
      <!-- Header with logos -->
      <div class="flex justify-between items-center mb-4">
        <img
          src="https://upload.wikimedia.org/wikipedia/commons/1/12/PMGO_Logo.png"
          alt="PMGO Logo"
          class="h-24"
        />
        <img
          src="https://upload.wikimedia.org/wikipedia/commons/b/bf/Bras%C3%A3o_de_Goi%C3%A1s.svg"
          alt="Estado de Goiás Coat of Arms"
          class="h-24"
        />
      </div>

      <!-- Headers -->
      <h2 class="text-2xl font-bold text-center mb-4">ESTADO DE GOIÁS</h2>
      <h3 class="text-xl font-bold text-center mb-2">
        SECRETARIA DE SEGURANÇA PÚBLICA
      </h3>
      <h3 class="text-xl font-bold text-center mb-2">
        POLÍCIA MILITAR DO ESTADO DE GOIÁS
      </h3>
      <div class="mb-2">
        <input
          type="text"
          class="header-input"
          placeholder="(informar CRPM) COMANDO REGIONAL DE POLÍCIA MILITAR"
        />
      </div>
      <div class="mb-4">
        <input
          type="text"
          class="header-input"
          placeholder="(informar unidade) DE POLÍCIA MILITAR"
        />
      </div>

      <h3 class="text-xl font-bold text-center mb-2 mt-6">
        TERMO DE MANIFESTAÇÃO DO OFENDIDO
      </h3>
      <p class="text-center mb-6">
        Artigo 69 - Lei 9.099/1995 c/c<br />
        Artigo 39 – Decreto- lei 3689/1941<br />
        Provimento nº 18/2015 - Corregedoria Geral de Justiça do Estado de Goiás
      </p>

      <p class="mb-4 mx-2 my-1">
        Eu
        <input type="text" class="input-field w-3/4 inline-block mx-2 my-1" />,
        já devidamente qualificado (a) no Termo Circunstanciado de Ocorrência
        lavrado pela Polícia Militar sob nº
        <input type="text" class="input-field w-16 inline-block mx-2 my-1" />/
        <input
          type="text"
          class="input-field w-16 inline-block mx-2 my-1"
          placeholder="Ano"
        />
        -
        <input
          type="text"
          class="input-field w-24 inline-block mx-2 my-1"
          placeholder="Unidade"
        />
        e RAI nº
        <input type="text" class="input-field w-32 inline-block mx-2 my-1" />,
        por este instrumento, manifesto meu interesse em REPRESENTAR em desfavor
        do autor do fato constante no respectivo Termo de Ocorrência.
      </p>

      <p class="mb-8 mx-2 my-1">
        Declaro estar ciente de que devo comparecer ao JUIZADO ESPECIAL CRIMINAL
        da Comarca de
        <input
          type="text"
          class="input-field inline-block w-48 mx-2 my-1"
          placeholder="Alto Paraíso de Goiás"
        />, no dia
        <input type="text" class="input-field w-16 inline-block" />/<input
          type="text"
          class="input-field w-16 inline-block"
        />/
        <input
          type="text"
          class="input-field w-16 inline-block"
          placeholder="Ano"
        />, às
        <input type="text" class="input-field w-16 inline-block" />:<input
          type="text"
          class="input-field w-16 inline-block"
        />
        horas ou em dia e hora a serem determinados posteriormente, quando da
        intimação do referido juízo na forma da lei.
      </p>

      <p class="mt-12 mb-2">
        <input
          type="text"
          class="input-field inline-block w-48"
          placeholder="Alto Paraíso de Goiás"
        />
        / GO, <input type="text" class="input-field w-16 inline-block" /> de
        <input type="text" class="input-field w-32 inline-block" /> de
        <input
          type="text"
          class="input-field w-16 inline-block"
          placeholder="Ano"
        />.
      </p>

      <div class="mt-12 mb-8">
        <p class="mb-1">Policial Militar:</p>
        <p>(Posto/Graduação, RG, nome e assinatura)</p>
        <br />

        <!-- Campo editável para o nome do policial -->
        <input
          type="text"
          class="signature-name-field"
          id="nome-policial-manifestacao"
          placeholder="Nome do Policial Militar"
        />

        <!-- Área de assinatura digital para o policial -->
        <div class="signature-container">
          <canvas
            id="signature-pad-policial-manifestacao"
            class="signature-pad"
            width="500"
            height="150"
          ></canvas>
          <button
            type="button"
            class="clear-button no-print"
            id="clear-policial-manifestacao"
          >
            Limpar
          </button>
        </div>
      </div>

      <div class="mt-8">
        <p class="mb-1">Vítima/Representante:</p>
        <p>(Nome completo e assinatura)</p>
        <br />

        <!-- Campo editável para o nome da vítima -->
        <input
          type="text"
          class="signature-name-field"
          id="nome-vitima-manifestacao"
          placeholder="Nome da Vítima/Representante"
        />

        <!-- Área de assinatura digital para a vítima -->
        <div class="signature-container">
          <canvas
            id="signature-pad-vitima-manifestacao"
            class="signature-pad"
            width="500"
            height="150"
          ></canvas>
          <button
            type="button"
            class="clear-button no-print"
            id="clear-vitima-manifestacao"
          >
            Limpar
          </button>
        </div>
      </div>
    </div>

    <!-- Tab 3: Termo de Compromisso de Comparecimento -->
    <div
      id="termo-compromisso"
      class="tab-content max-w-4xl mx-auto bg-white p-6 rounded shadow"
    >
      <!-- Header with logos -->
      <div class="flex justify-between items-center mb-4">
        <img
          src="https://upload.wikimedia.org/wikipedia/commons/1/12/PMGO_Logo.png"
          alt="PMGO Logo"
          class="h-24"
        />
        <img
          src="https://upload.wikimedia.org/wikipedia/commons/b/bf/Bras%C3%A3o_de_Goi%C3%A1s.svg"
          alt="Estado de Goiás Coat of Arms"
          class="h-24"
        />
      </div>

      <!-- Headers -->
      <h2 class="text-2xl font-bold text-center mb-4">ESTADO DE GOIÁS</h2>
      <h3 class="text-xl font-bold text-center mb-2">
        SECRETARIA DE SEGURANÇA PÚBLICA
      </h3>
      <h3 class="text-xl font-bold text-center mb-2">
        POLÍCIA MILITAR DO ESTADO DE GOIÁS
      </h3>
      <div class="mb-2">
        <input
          type="text"
          class="header-input"
          placeholder="(informar CRPM) COMANDO REGIONAL DE POLÍCIA MILITAR"
        />
      </div>
      <div class="mb-4">
        <input
          type="text"
          class="header-input"
          placeholder="(informar unidade) DE POLÍCIA MILITAR"
        />
      </div>

      <h3 class="text-xl font-bold text-center mb-2 mt-6">
        TERMO DE COMPROMISSO DE COMPARECIMENTO
      </h3>
      <p class="text-center mb-6">
        Artigo 69 - Lei 9.099/1995 c/c<br />
        Provimento nº 18/2015 - Corregedoria Geral de Justiça do Estado de Goiás
      </p>

      <p class="mb-4">
        Nos termos do parágrafo único do art. 69 da lei 9.099/95, deixo de impor
        prisão em flagrante delito a
        <input type="text" class="input-field w-3/4 inline-block mx-2 my-1" />
        já devidamente qualificado, em razão da lavratura do Termo
        Circunstanciado de Ocorrência nº:
        <input type="text" class="input-field w-16 inline-block mx-2 my-1" />/
        <input
          type="text"
          class="input-field w-16 inline-block mx-2 my-1"
          placeholder="Ano"
        />
        -
        <input
          type="text"
          class="input-field w-24 inline-block"
          placeholder="Unidade"
        />
        e RAI nº <input type="text" class="input-field w-32 inline-block" />, e
        que, por este instrumento, ASSUME o compromisso de comparecer ao JUIZADO
        ESPECIAL CRIMINAL da Comarca de
        <input
          type="text"
          class="input-field inline-block w-48"
          placeholder="Alto Paraíso de Goiás"
        />
        / GO, no dia
        <input type="text" class="input-field w-16 inline-block" />/<input
          type="text"
          class="input-field w-16 inline-block"
        />/
        <input
          type="text"
          class="input-field w-16 inline-block"
          placeholder="Ano"
        />, às
        <input type="text" class="input-field w-16 inline-block" />:<input
          type="text"
          class="input-field w-16 inline-block"
        />
        horas ou em dia e hora a serem determinados posteriormente quando da
        intimação do referido juízo na forma da lei.
      </p>

      <p class="mb-8">
        Fica ciente que, o não comparecimento, o sujeitará às sanções legais,
        bem como deverá comparecer acompanhado por advogado, sendo que, na sua
        falta, ser-lhe-á designado defensor público.
      </p>

      <p class="mt-12 mb-2">
        <input
          type="text"
          class="input-field inline-block w-48"
          placeholder="Alto Paraíso de Goiás"
        />
        / GO, <input type="text" class="input-field w-16 inline-block" /> de
        <input type="text" class="input-field w-32 inline-block" /> de
        <input
          type="text"
          class="input-field w-16 inline-block"
          placeholder="Ano"
        />.
      </p>

      <div class="mt-12 mb-4">
        <p class="mb-1">Policial Militar:</p>
        <p>(Posto/Graduação, RG, nome e assinatura)</p>
        <br />

        <!-- Campo editável para o nome do policial -->
        <input
          type="text"
          class="signature-name-field"
          id="nome-policial-compromisso"
          placeholder="Nome do Policial Militar"
        />

        <!-- Área de assinatura digital para o policial -->
        <div class="signature-container">
          <canvas
            id="signature-pad-policial-compromisso"
            class="signature-pad"
            width="500"
            height="150"
          ></canvas>
          <button
            type="button"
            class="clear-button no-print"
            id="clear-policial-compromisso"
          >
            Limpar
          </button>
        </div>
      </div>

      <div class="mb-8">
        <p class="mb-1">
          Data e Hora:
          <input type="text" class="input-field w-16 inline-block" />/<input
            type="text"
            class="input-field w-16 inline-block"
          />/
          <input
            type="text"
            class="input-field w-16 inline-block"
            placeholder="Ano"
          />
          às <input type="text" class="input-field w-16 inline-block" />:<input
            type="text"
            class="input-field w-16 inline-block"
          />
          horas.
        </p>
      </div>

      <div class="mt-8">
        <p class="mb-1">Compromissado (autor):</p>
        <p>(Nome completo e assinatura)</p>
        <br />

        <!-- Campo editável para o nome do autor -->
        <input
          type="text"
          class="signature-name-field"
          id="nome-autor-compromisso"
          placeholder="Nome do Compromissado (autor)"
        />

        <!-- Área de assinatura digital para o autor -->
        <div class="signature-container">
          <canvas
            id="signature-pad-autor-compromisso"
            class="signature-pad"
            width="500"
            height="150"
          ></canvas>
          <button
            type="button"
            class="clear-button no-print"
            id="clear-autor-compromisso"
          >
            Limpar
          </button>
        </div>
      </div>
    </div>

    <!-- Buttons - outside the print container -->
    <div class="max-w-4xl mx-auto mt-4 flex space-x-4 no-print">
      <button
        onclick="exportToPDF()"
        class="bg-green-500 text-white px-4 py-2 rounded no-print"
      >
        Exportar para PDF
      </button>
      <button
        onclick="shareViaWhatsApp()"
        class="bg-green-500 text-white px-4 py-2 rounded no-print"
      >
        Enviar via WhatsApp
      </button>
    </div>

    <!-- Footer -->
    <footer class="footer no-print">
      <div class="max-w-4xl mx-auto">
        <p>
          Desenvolvido por Antonio Rafael -
          <a href="https://wa.me/5561982887294" target="_blank" rel="noopener">
            Entrar em contato
          </a>
        </p>
      </div>
    </footer>

    <script>
      // Initialize signature pads
      let signaturePadPolicialManifestacao;
      let signaturePadVitimaManifestacao;
      let signaturePadPolicialCompromisso;
      let signaturePadAutorCompromisso;

      document.addEventListener("DOMContentLoaded", function () {
        // Inicializar os pads de assinatura
        signaturePadPolicialManifestacao = new SignaturePad(
          document.getElementById("signature-pad-policial-manifestacao")
        );
        signaturePadVitimaManifestacao = new SignaturePad(
          document.getElementById("signature-pad-vitima-manifestacao")
        );
        signaturePadPolicialCompromisso = new SignaturePad(
          document.getElementById("signature-pad-policial-compromisso")
        );
        signaturePadAutorCompromisso = new SignaturePad(
          document.getElementById("signature-pad-autor-compromisso")
        );

        // Botões para limpar assinaturas
        document
          .getElementById("clear-policial-manifestacao")
          .addEventListener("click", function () {
            signaturePadPolicialManifestacao.clear();
          });

        document
          .getElementById("clear-vitima-manifestacao")
          .addEventListener("click", function () {
            signaturePadVitimaManifestacao.clear();
          });

        document
          .getElementById("clear-policial-compromisso")
          .addEventListener("click", function () {
            signaturePadPolicialCompromisso.clear();
          });

        document
          .getElementById("clear-autor-compromisso")
          .addEventListener("click", function () {
            signaturePadAutorCompromisso.clear();
          });
      });

      // Tab switching functionality
      function openTab(evt, tabName) {
        // Hide all tab contents
        const tabContents = document.getElementsByClassName("tab-content");
        for (let i = 0; i < tabContents.length; i++) {
          tabContents[i].classList.remove("active");
        }

        // Remove active class from all tabs
        const tabs = document.getElementsByClassName("tab");
        for (let i = 0; i < tabs.length; i++) {
          tabs[i].classList.remove("active");
        }

        // Show the specific tab content
        document.getElementById(tabName).classList.add("active");

        // Add an active class to the button that opened the tab
        evt.currentTarget.classList.add("active");
      }

      // Track the currently active tab for PDF generation
      function getCurrentActiveTab() {
        const tabContents = document.getElementsByClassName("tab-content");
        for (let i = 0; i < tabContents.length; i++) {
          if (tabContents[i].classList.contains("active")) {
            return tabContents[i];
          }
        }
        return document.getElementById("relatorio-medico"); // Default
      }

      async function generatePDF() {
        const element = getCurrentActiveTab();

        // Add export-mode class to hide signature pad borders
        element.classList.add("export-mode");

        // Temporariamente ocultar botões de limpar durante exportação
        const clearButtons = element.querySelectorAll(".clear-button");
        clearButtons.forEach((button) => (button.style.display = "none"));

        // Ensure images are loaded before generating PDF
        await Promise.all(
          Array.from(element.querySelectorAll("img")).map((img) => {
            if (img.complete) return Promise.resolve();
            return new Promise((resolve) => {
              img.onload = resolve;
              img.onerror = resolve;
            });
          })
        );

        // Configurações otimizadas para A4
        const canvas = await html2canvas(element, {
          scale: 3, // Aumentado para melhor qualidade
          useCORS: true,
          allowTaint: true,
          logging: false,
          width: element.scrollWidth,
          height: element.scrollHeight,
          backgroundColor: "#ffffff",
        });

        // Remove export-mode class after canvas capture
        element.classList.remove("export-mode");

        // Restaurar botões de limpar após a captura
        clearButtons.forEach((button) => (button.style.display = "block"));

        const imgData = canvas.toDataURL("image/png", 1.0);
        const { jsPDF } = window.jspdf;

        // Configurações A4 em mm
        const pdf = new jsPDF("p", "mm", "a4");
        const pdfWidth = 210; // A4 width in mm
        const pdfHeight = 297; // A4 height in mm
        const margin = 10; // Margem em mm

        // Área útil do PDF
        const usableWidth = pdfWidth - margin * 2;
        const usableHeight = pdfHeight - margin * 2;

        // Dimensões da imagem
        const imgWidth = canvas.width / 3; // Dividido pela escala
        const imgHeight = canvas.height / 3;

        // Calcular proporção para caber na página
        const ratio = Math.min(
          usableWidth / imgWidth,
          usableHeight / imgHeight
        );

        // Dimensões finais da imagem no PDF
        const finalWidth = imgWidth * ratio;
        const finalHeight = imgHeight * ratio;

        // Centralizar a imagem
        const imgX = (pdfWidth - finalWidth) / 2;
        const imgY = margin;

        // Se a imagem for muito alta, pode precisar de múltiplas páginas
        if (finalHeight > usableHeight) {
          let yPosition = 0;
          const pageHeight = usableHeight;

          while (yPosition < imgHeight) {
            const sourceY = yPosition;
            const sourceHeight = Math.min(
              pageHeight / ratio,
              imgHeight - yPosition
            );

            if (yPosition > 0) {
              pdf.addPage();
            }

            // Criar um canvas temporário para a seção atual
            const tempCanvas = document.createElement("canvas");
            const tempCtx = tempCanvas.getContext("2d");
            tempCanvas.width = canvas.width;
            tempCanvas.height = sourceHeight * 3; // Multiplicado pela escala

            tempCtx.drawImage(
              canvas,
              0,
              sourceY * 3,
              canvas.width,
              sourceHeight * 3,
              0,
              0,
              canvas.width,
              sourceHeight * 3
            );

            const tempImgData = tempCanvas.toDataURL("image/png", 1.0);
            pdf.addImage(
              tempImgData,
              "PNG",
              imgX,
              margin,
              finalWidth,
              sourceHeight * ratio
            );

            yPosition += sourceHeight;
          }
        } else {
          pdf.addImage(imgData, "PNG", imgX, imgY, finalWidth, finalHeight);
        }

        return pdf;
      }

      async function exportToPDF() {
        const pdf = await generatePDF();
        // Get name of the current tab for the filename
        const activeTabId = getCurrentActiveTab().id;
        let filename = "documento";

        if (activeTabId === "relatorio-medico") {
          filename = "relatorio_medico";
        } else if (activeTabId === "termo-manifestacao") {
          filename = "termo_manifestacao";
        } else if (activeTabId === "termo-compromisso") {
          filename = "termo_compromisso";
        }

        pdf.save(`${filename}.pdf`);
      }

      async function shareViaWhatsApp() {
        const pdf = await generatePDF();
        const blob = pdf.output("blob");

        // Get name of the current tab for the filename
        const activeTabId = getCurrentActiveTab().id;
        let filename = "documento";
        let title = "Documento";

        if (activeTabId === "relatorio-medico") {
          filename = "relatorio_medico";
          title = "Relatório Médico";
        } else if (activeTabId === "termo-manifestacao") {
          filename = "termo_manifestacao";
          title = "Termo de Manifestação do Ofendido";
        } else if (activeTabId === "termo-compromisso") {
          filename = "termo_compromisso";
          title = "Termo de Compromisso de Comparecimento";
        }

        const file = new File([blob], `${filename}.pdf`, {
          type: "application/pdf",
        });

        if (navigator.share) {
          try {
            await navigator.share({
              files: [file],
              title: title,
              text: `Aqui está o documento: ${title}`,
            });
          } catch (error) {
            console.error("Erro ao compartilhar:", error);
            alert("Não foi possível compartilhar. Baixando o PDF...");
            exportToPDF();
          }
        } else {
          alert("Compartilhamento não suportado. Baixando o PDF...");
          exportToPDF();
        }
      }
    </script>

    <script>
      // Registrar Service Worker
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", function () {
          navigator.serviceWorker
            .register("/service-worker.js")
            .then(function (registration) {
              console.log(
                "ServiceWorker registrado com sucesso: ",
                registration.scope
              );
            })
            .catch(function (error) {
              console.log("Falha no registro do ServiceWorker: ", error);
            });
        });
      }

      // Detectar se está em modo PWA
      window.isPWA = function () {
        return (
          window.matchMedia("(display-mode: standalone)").matches ||
          window.navigator.standalone ||
          document.referrer.includes("android-app://")
        );
      };
    </script>
  </body>
</html>
